<!DOCTYPE html>
<html lang="zh-cn"><meta charset="utf-8"><meta name="generator" content="Hugo 0.62.2" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>gRPC &#43; Golang &#43; python 初窥门径&nbsp;&ndash;&nbsp;HeQing&#39;s Blog</title><link rel="stylesheet" href="/myblog/css/core.min.0fd0248e8ca66c409930a84a422f95c79fe473ea867f1077a26ff821e5982062fc8d983edbd47ec0a95b4757f8e87fc4.css" integrity="sha384-D9AkjoymbECZMKhKQi&#43;Vx5/kc&#43;qGfxB3om/4IeWYIGL8jZg&#43;29R&#43;wKlbR1f46H/E"><body>
    <div class="base-body"><section id="header" class="site header max-body-width">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/myblog/"><span class="site name">HeQing&#39;s Blog</span></a></span>
        <span class="header right-side"><div class="nav wrap"><div class="nav"><a class="nav item" href="/myblog/categories/">Categories</a><a class="nav item" href="/myblog/tags/">Tags</a><a class="nav item" href="/myblog/about/">About</a></div></div></span></div></section><div id="content" class="max-body-width"><section class="article header">
    <h1 class="article title">gRPC + Golang + python 初窥门径</h1><p class="article date">Jan 08, 2020</p></section><article class="article markdown-body"><h2 id="环境准备">环境准备</h2>
<ol>
<li>配置 gRPC for Golang
<ul>
<li>安装 <em>grpc</em>
<blockquote>
<p>go get -u google.golang.org/grpc</p>
</blockquote>
</li>
<li>安装 <em>protoc-gen-go</em>
<blockquote>
<p>go get -u github.com/golang/protobuf/protoc-gen-go</p>
</blockquote>
</li>
</ul>
</li>
<li>配置 gRPC for python
<ul>
<li>安装 <em>grpcio</em>
<blockquote>
<p>python -m pip install grpcio</p>
</blockquote>
</li>
<li>安装 <em>grpcio-tools</em>
<blockquote>
<p>python -m pip install grpcio-tools</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<h2 id="编辑-protocol-buffer-协议">编辑 <em><strong>protocol buffer</strong></em> 协议</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">    <span class="nx">syntax</span> <span class="p">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span>

    <span class="kn">package</span> <span class="nx">myhello</span><span class="p">;</span>

    <span class="c1">// my test service
</span><span class="c1"></span>    <span class="nx">service</span> <span class="nx">MyTest</span> <span class="p">{</span>
        <span class="c1">// my test foo
</span><span class="c1"></span>        <span class="nx">rpc</span> <span class="nf">MyFoo</span> <span class="p">(</span><span class="nx">MyRequest</span><span class="p">)</span> <span class="nf">returns</span> <span class="p">(</span><span class="nx">MyResponse</span><span class="p">)</span> <span class="p">{</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// the test req
</span><span class="c1"></span>    <span class="nx">message</span> <span class="nx">MyRequest</span> <span class="p">{</span>
        <span class="kt">string</span> <span class="nx">name</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// the test reply
</span><span class="c1"></span>    <span class="nx">message</span> <span class="nx">MyResponse</span> <span class="p">{</span>
        <span class="kt">string</span> <span class="nx">reply</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div><h2 id="生成-protocol-对应代码">生成 <em><strong>protocol</strong></em> 对应代码</h2>
<ol>
<li>生成 Golang gRPC 代码
<ul>
<li>执行 <em>protoc</em> 命令
<blockquote>
<p>protoc -I myhello\ &ndash;go_out=plugins=grpc:myhello\ myhello\myhello.proto</p>
</blockquote>
</li>
<li>得到 <em>myhello.pb.go</em> 库文件</li>
</ul>
</li>
<li>生成 Python gRPC 代码
<ul>
<li>调用 <em>grpc_tools</em> 模块
<blockquote>
<p>python -m grpc_tools.protoc -I myhello\ &ndash;python_out=myhello\ &ndash;grpc_python_out=myhello\ myhello\myhello.proto</p>
</blockquote>
</li>
<li>得到 <em>myhello_pb2.py</em>， <em>myhello_pb2_grpc.py</em> 两个库文件</li>
</ul>
</li>
</ol>
<h2 id="grpc-服务端-golang">gRPC 服务端 Golang</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">    <span class="kn">package</span> <span class="nx">main</span>

    <span class="kn">import</span> <span class="p">(</span>
        <span class="s">&#34;context&#34;</span>
        <span class="s">&#34;log&#34;</span>
        <span class="s">&#34;net&#34;</span>
        <span class="nx">pb</span> <span class="s">&#34;test/grpc_test/myhello&#34;</span>

        <span class="s">&#34;google.golang.org/grpc&#34;</span>
    <span class="p">)</span>

    <span class="kd">const</span> <span class="p">(</span>
        <span class="nx">port</span> <span class="p">=</span> <span class="s">&#34;:10002&#34;</span>
    <span class="p">)</span>

    <span class="kd">type</span> <span class="nx">server</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">pb</span><span class="p">.</span><span class="nx">UnimplementedMyTestServer</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">)</span> <span class="nf">MyFoo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">MyRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">MyResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Received from : %v&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">MyResponse</span><span class="p">{</span><span class="nx">Reply</span><span class="p">:</span> <span class="s">&#34;Reply for &#34;</span> <span class="o">+</span> <span class="nx">in</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(</span><span class="p">)</span><span class="p">}</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">lis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to listen: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;start to serve on localhost&#34;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">)</span>
        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="p">)</span>
        <span class="nx">pb</span><span class="p">.</span><span class="nf">RegisterMyTestServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">server</span><span class="p">{</span><span class="p">}</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">lis</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to serve: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div><h2 id="grpc-客户端-python">gRPC 客户端 Python</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="kn">import</span> <span class="nn">grpc</span>
    <span class="kn">import</span> <span class="nn">myhello_pb2</span>
    <span class="kn">import</span> <span class="nn">myhello_pb2_grpc</span>

    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">__main__</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">localhost:10002</span><span class="s2">&#34;</span><span class="p">)</span>
        <span class="n">stub</span> <span class="o">=</span> <span class="n">myhello_pb2_grpc</span><span class="o">.</span><span class="n">MyTestStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">MyFoo</span><span class="p">(</span><span class="n">myhello_pb2</span><span class="o">.</span><span class="n">MyRequest</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">My Python Client</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">rep</span><span class="o">.</span><span class="n">reply</span><span class="p">)</span>
</code></pre></div><h2 id="测试">测试</h2>
<ol>
<li><em>golang</em> 服务端
<blockquote>
<p>PS C:\Users\admin\go\src\test\grpc_test&gt; go run .\server.go<br>
2020/01/08 14:54:34 start to serve on localhost:10002<br>
2020/01/08 15:18:38 Received from : My Python Client</p>
</blockquote>
</li>
<li><em>python</em> 客户端
<blockquote>
<p>PS C:\Users\admin\go\src\test\grpc_test&gt; &amp; C:/python37/python.exe .\client.py<br>
Reply for My Python Client</p>
</blockquote>
</li>
</ol>
<h2 id="小结">小结</h2>
<ol>
<li><em><strong>gRPC</strong></em> 使用 <em><strong>protocol buffer</strong></em> 定义接口和交互数据，客户端可直接远程调用服务端接口。</li>
<li><em><strong>gRPC</strong></em> 的客户端和服务端可以运行在不同的环境上，也可以使用不同的语言实现， 对分布式的微服务十分友好。</li>
</ol>
</article><section class="article labels"><a class="article category" href=/myblog/categories/starter/><span class="hashtag">#</span>starter</a><a class="article tag" href=/myblog/tags/grpc/><span class="hashtag">#</span>gRPC</a><a class="article tag" href=/myblog/tags/golang/><span class="hashtag">#</span>Golang</a><a class="article tag" href=/myblog/tags/python/><span class="hashtag">#</span>Python</a><a class="article tag" href=/myblog/tags/protocol-buffer/><span class="hashtag">#</span>Protocol Buffer</a></section><section class="article navigation"><p><a class="link" href="/myblog/post/github-hugo-win/"><span class="li"></span>Windows使用Github Pages + Hugo 搭建个人博客</a class="link">
    </p></section></div><section id="footer" class="footer max-body-width"><div class="footer-wrap">
    <p class="copyright">HeQing's Blog</p>
    <p class="powerby"><span>Powered by </span><a href="https://gohugo.io" 
        target="_blank">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank">Notepadium</a></p>
</div></section></div>
</body>

</html>